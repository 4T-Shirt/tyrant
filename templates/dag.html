<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Tyrant</title>

    <!-- Bootstrap core CSS -->
    <link href="http://cdn.staticfile.org/twitter-bootstrap/3.1.1/css/bootstrap.min.css" rel="stylesheet">

    <style>
      body {
        padding-top: 50px;
      }

      .container {
        width: 90%;
      }

      .content {
        padding-top: 50px;
      }

      .table {
        table-layout: fixed;
        word-wrap: break-word;
      }
      td {
        max-width: 200px;
      }
    </style>

    <!-- Just for debugging purposes. Don't actually copy this line! -->
    <!--[if lt IE 9]><script src="../../assets/js/ie8-responsive-file-warning.js"></script><![endif]-->

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>

  <body>
    <script id="dag_row" type="text/template">
      <tr>
        <td> <%= name %> </td>
        <td> <%= schedule %> </td>
        <td> <%= owner %> </td>
        <td> <a href="#">Detail</a> </td>
        <td> <%= create_date %> </td>
        <td> <%= last_success_date %> </td>
        <td> <%= last_error_date %> </td>
        <td> <%= last_status %> </td>
        <td> <a href="#" class="">Force Run</a> | <a href="#" class="">Edit</a> | <a href="javascript:void(0)" class="remove-dag-btn" data-dagname="<%= name %>">Remove</a> </td>
      </tr>
    </script>

    <div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="/">Tyrant</a>
        </div>
        <div class="collapse navbar-collapse">
          <ul class="nav navbar-nav">
            <li><a href="/job">Job</a></li>
            <li><a href="/dag">Job Group</a></li>
            <li><a href="/status">Task Status</a></li>
            <li><a href="http://test451.hy01.wandoujia.com:8000/">Executor Upload</a></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </div>

    <div class="container content">
      <div class="row">
      <div class="col-md-9">
        <div class="dags">
          <table class="table table-striped table-hover">
            <thead>
              <tr>
                <th>Name</th>
                <th>Schedule</th>
                <th>Owner</th>
                <th>Dependencies</th>
                <th>Created Date</th>
                <th>Last Success Date</th>
                <th>Last Error Date</th>
                <th>Last Status</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
            </tbody>
          </table>
      </div>
      </div>
      <div class="col-md-2">
        <div id="message-box" class="alert alert-success">
          <a href="#" class="alert-link message"></a>
        </div>
        <form id="add-dag-form" role="form">
          <div class="form-group">
            <label for="inputName" class="control-label">Job Group Name</label>
            <input name="name" type="text" class="form-control" id="inputName">
          </div>

          <div class="form-group">
            <label for="inputExecutor" class="control-label">Schedule (crontab format)</label>
            <input type="text" name="schedule" class="form-control" id="inputSchedule">
          </div>

          <div class="form-group">
            <label for="inputExecutorFlag" class="control-label">Dependencies (jobs)</label>
            <textarea class="form-control" name="jobs" rows="3"></textarea>
          </div>

          <div class="form-group">
            <label for="inputOwner" class="control-label">Owner</label>
            <input type="text" class="form-control" name="owner" id="inputOwner">
          </div>

          <div class="form-group">
            <button type="submit" class="btn btn-default">Save</button>
          </div>
        </form>
      </div>

      </div>
    </div><!-- /.container -->

    <script src="http://cdn.staticfile.org/jquery/2.1.1-rc2/jquery.min.js"></script>
    <script src="http://cdn.staticfile.org/underscore.js/1.6.0/underscore-min.js"></script>
    <script src="http://cdn.staticfile.org/twitter-bootstrap/3.1.1/js/bootstrap.min.js"></script>
    <script src="utils.js"></script>

    <script>
      $(document).ready(function() {
        $("#message-box").hide()

        var dag_row_tmpl = _.template($('#dag_row').html());

        var load_dag_list = function() {
          $.get('/dag/list', function(e) {
            console.log(e)
            $(".dags table tbody").html("");
            var content = JSON.parse(e)
            if (content.data == null) return;
            $.each(content.data, function(idx) {
              var dag = content.data[idx];
              dag.create_date = TimestampToDate(dag.create_ts);
              dag.last_success_date = "";
              dag.last_error_date = "";
              $(".dags table tbody").append(dag_row_tmpl(dag));
            });
          });
        }
        load_dag_list()

        $("#add-dag-form").submit(function(event) {
          var s = JSON.stringify($(this).serializeObject());
          console.log(s);
          $.ajax({
            contentType: "application/json",
            data : s,
            dataType: "json",
            type: "POST",
            url: "/dag/new",
            success: function(data){
              if (data.ret == 0) {
                load_dag_list()
                setTimeout(function() {
                  $("#message-box").hide();
                }, 1000);
              }
            }
          })
          event.preventDefault();
        });

        $(document).on("click", ".remove-dag-btn", function() {
          var dagname = $(this).data("dagname")
          $.post("/dag/remove?name=" + dagname, function(e) {
            load_dag_list();
          })
        })
      });
    </script>
  </body>
</html>
