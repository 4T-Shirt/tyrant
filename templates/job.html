<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Tyrant</title>

    <!-- Bootstrap core CSS -->
    <link href="http://cdn.staticfile.org/twitter-bootstrap/3.1.1/css/bootstrap.min.css" rel="stylesheet">

    <style>
      body {
        padding-top: 50px;
      }

      .container {
        width: 90%;
      }

      .content {
        padding-top: 50px;
      }

      .table {
        table-layout: fixed;
        word-wrap: break-word;
      }
      td {
        max-width: 200px;
      }
    </style>

    <!-- Just for debugging purposes. Don't actually copy this line! -->
    <!--[if lt IE 9]><script src="../../assets/js/ie8-responsive-file-warning.js"></script><![endif]-->

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>

  <body>
    <script id="dagjob_row" type="text/template">
      <tr>
        <td> <%= name %> </td>
        <td> <a href="#" class="">Edit</a> | <a href="#" class="">Remove</a> </td>
      </tr>
    </script>

    <script id="job_row" type="text/template">
      <tr>
        <td> <%= name %> </td>
        <td> <%= executor %> </td>
        <td> <%= owner %> </td>
        <td> <%= command %> </td>
        <td> <%= create_ts %> </td>
        <td>  <a href="#" class="">Edit</a> | <a href="#" class="">Remove</a> </td>
      </tr>
    </script>

    <div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#">Tyrant</a>
        </div>
        <div class="collapse navbar-collapse">
          <ul class="nav navbar-nav">
            <li><a>Job</a></li>
            <li><a>DAG</a></li>
            <li><a>Task Status</a></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </div>

    <div class="container content">
      <div class="row">
      <div class="col-md-7">
        <div class="jobs">
          <table class="table table-striped table-hover">
            <thead>
              <tr>
                <th>Name</th>
                <th>Executor</th>
                <th>Owner</th>
                <th>Command</th>
                <th>Created Date</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
            </tbody>
          </table>
      </div>
      </div>
      <div class="col-md-5">
        <div id="message-box" class="alert alert-success">
          <a href="#" class="alert-link message"></a>
        </div>
        <form id="add-job-form" role="form">
          <div class="form-group">
            <label for="inputName" class="control-label">Job Name</label>
            <input name="name" type="text" class="form-control" id="inputName">
          </div>

          <div class="form-group">
            <label for="inputExecutor" class="control-label">Executor</label>
            <input type="text" name="executor" class="form-control" id="inputExecutor">
          </div>

          <div class="form-group">
            <label for="inputExecutorFlag" class="control-label">Executor Flags</label>
            <input type="text" class="form-control" name="executor_flag" id="inputExecutorFlag">
          </div>

          <div class="form-group">
            <label for="inputOwner" class="control-label">Owner</label>
            <input type="text" class="form-control" name="owner" id="inputOwner">
          </div>

          <div class="form-group">
            <label for="inputCommand" class="control-label">Command</label>
            <textarea class="form-control" name="command" rows="3"></textarea>
          </div>

          <div class="form-group">
            <button type="submit" class="btn btn-default">Save</button>
          </div>
        </form>
      </div>

      </div>
    </div><!-- /.container -->

    <script src="http://cdn.staticfile.org/jquery/2.1.1-rc2/jquery.min.js"></script>
    <script src="http://cdn.staticfile.org/underscore.js/1.6.0/underscore-min.js"></script>
    <script src="http://cdn.staticfile.org/twitter-bootstrap/3.1.1/js/bootstrap.min.js"></script>

    <script>
      $(document).ready(function() {
        $("#message-box").hide()
        // helper function
        $.fn.serializeObject = function() {
            var o = {};
            var a = this.serializeArray();
            $.each(a, function() {
                if (o[this.name] !== undefined) {
                    if (!o[this.name].push) {
                        o[this.name] = [o[this.name]];
                    }
                    o[this.name].push(this.value || '');
                } else {
                    o[this.name] = this.value || '';
                }
            });
            return o;
        };
        // end of helper

        var job_row_teml = _.template($('#job_row').html());

        var load_job_list = function() {
          $.get('/job/list', function(e) {
            $(".jobs table tbody").html("");
            var content = JSON.parse(e)
            if (content.data == null) return;
            $.each(content.data, function(idx) {
              var job = content.data[idx];
              $(".jobs table tbody").append(job_row_teml(job));
            });
          });
        }
        load_job_list()

        $("#add-job-form").submit(function(event) {
          var s = JSON.stringify($(this).serializeObject());
          console.log(s);
          $("#message-box").show();
          $.ajax({
            contentType: "application/json",
            data : s,
            dataType: "json",
            type: "POST",
            url: "/job/new",
            success: function(data){
              if (data.ret == 0) {
                load_job_list()
                setTimeout(function() {
                  $("#message-box").hide();
                }, 1000);
              }
            }
          })
          event.preventDefault();
        });
      });
    </script>
  </body>
</html>
